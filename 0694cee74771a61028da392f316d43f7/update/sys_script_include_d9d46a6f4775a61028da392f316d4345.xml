<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1755799_xlupload.readEXCEL</api_name>
        <caller_access/>
        <client_callable>true</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>readEXCEL</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var readEXCEL = Class.create();
readEXCEL.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
    prepareData: function(row) {
        var myData = {};
        myData.ent_id = row['ENT ID']; 
        myData.ent_name = row['ENT NAME']; 
        myData.type = row['TYPE']; 
        myData.comment = row['COMMENT']; 
        return myData;
    },

    getData: function() {
        try {
            var id = this.getParameter('sysparm_id'); 
            var myObjArray = []; 
            
            // Query attachment record
            var gr = new GlideRecord('sys_attachment');
            if (!gr.get(id)) {
                return JSON.stringify({error: 'Attachment does not exist or has been deleted'});
            }
            
            // Validate file type
            var contentType = gr.getValue('content_type');
            if (!contentType.startsWith('application/vnd.ms-excel') && 
                !contentType.startsWith('application/vnd.openxmlformats-officedocument.spreadsheetml')) {
                return JSON.stringify({error: 'Please upload a valid Excel file'});
            }
            
            // Parse Excel
            var parser = new sn_impex.GlideExcelParser(); 
            var attachment = new GlideSysAttachment();
            var attachmentStream = attachment.getContentStream(id);
            parser.parse(attachmentStream); 

            var headers = [];
            var isHeaderRow = true;
            
            // Process data row by row (first row is headers, others are data)
            while (parser.next()) { 
                var row = parser.getRow();
                if (!row || Object.keys(row).length === 0) continue;
                
                if (isHeaderRow) {
                    // Use first row as headers
                    headers = Object.keys(row);
                    gs.info('Retrieved headers: ' + headers);
                    
                    // Validate required columns
                    var requiredColumns = ['ENT ID', 'ENT NAME', 'TYPE', 'COMMENT'];
                    for (var i = 0; i < requiredColumns.length; i++) {
                        if (!headers.includes(requiredColumns[i])) {
                            return JSON.stringify({error: 'Excel file is missing required column: ' + requiredColumns[i]});
                        }
                    }
                    
                    isHeaderRow = false; // Mark headers as processed
                    continue; // Skip headers row, do not add to results
                }
                
                // Process data row
                myObjArray.push(this.prepareData(row)); 
            }
            
            // Check if there are data rows
            if (myObjArray.length === 0) {
                return JSON.stringify({error: 'No data rows found in Excel file'});
            }
            
            return JSON.stringify({success: true, data: myObjArray});
        } catch (e) {
            gs.error('Excel parsing error: ' + e);
            return JSON.stringify({error: 'Error parsing Excel: ' + e.message});
        }
    },

    type: 'readEXCEL'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-06-04 05:43:25</sys_created_on>
        <sys_id>d9d46a6f4775a61028da392f316d4345</sys_id>
        <sys_mod_count>10</sys_mod_count>
        <sys_name>readEXCEL</sys_name>
        <sys_package display_value="XlUpload" source="x_1755799_xlupload">0694cee74771a61028da392f316d43f7</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="XlUpload">0694cee74771a61028da392f316d43f7</sys_scope>
        <sys_update_name>sys_script_include_d9d46a6f4775a61028da392f316d4345</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-06-04 06:28:57</sys_updated_on>
    </sys_script_include>
</record_update>
